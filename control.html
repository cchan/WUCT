<html>
<head>
  <script src="//d2wy8f7a9ursnm.cloudfront.net/v5/bugsnag.min.js"></script>
  <script>window.bugsnagClient = bugsnag('e68a9c7e8df6ed36d155702829ec5705')</script>

  <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-messaging.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="common.js?1560654662677"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha256-YLGeXaapI0/5IgZopewRJcFXomhRMlYYjugPLSyNjTY=" crossorigin="anonymous" />
  <link rel="stylesheet" href="main.css?1560654662677" />
</head>
<body>
  <style>input[type=text]{border: solid 1px #ccc;}</style>
  <div id="not-logged-in" style="color: red">You are not logged in. You can see these settings but cannot change them. Go to the <a href="scoring.html">scoring page</a> to log in.</div>
  <header>
    <h1><img src="wuct.jpg" alt="WUCT" />Breaking Bonds Round: Control Panel</h1>
  </header>

  <h2>Timer</h2>
  <p>The recommended way of using the timer is:</p>
  <ul>
    <li>Set it to 999999999999 until you're ready to start (the timer will only display up to the limit, so it'll just sit there)</li>
    <li>Set it to 60 (or whatever the limit may be) once the round starts</li>
    <li>Use a scoreboard-hiding time of around 5 minutes to create a bit of suspense during the awards ceremony (optional; to avoid this just set the score-hiding time to a large negative value)</li>
  </ul>
  <p>Timer is <input type="text" id="timerlength" /> minutes long and hides scores at <input type="text" id="hidetime" /> minutes.</p>
  <p><form action="" method="GET" id="timerset_form">Set timer to <input type="text" id="timerplus" /> minutes: <input type="submit" id="timerset" /></form></p>
  <p>CURRENT TIMER DISPLAY: <span id="timer">not loaded yet</span></p>
  
  <h2>Active Scoring Stations <sup><small><a href="https://github.com/cchan/WUCT/issues">beta</a></small></sup></h2>
  <p>This tracks all currently active scoring stations and all teams that they are tracking. Scoring stations may identify themselves using the Identifier textbox in the scoring page header. Use the 'x' to remove stray scoring stations (which forces them to log out).</p>
  <div id="stations"></div>
  
  <h2>Teams</h2>
  <input type="text" placeholder="id" id="newid" />
  <input type="text" placeholder="new name" id="newname" />
  <input type="submit" value="Add/Set team name" onclick="addTeam();" />
  
  <div id="teamlist"></div>

  <h2>Copyable Scoreboard Table</h2>
  <div id="scoreboard"></div>
  
  <script>
    $.fn.outerHTML = function(){
      // https://css-tricks.com/snippets/jquery/outerhtml-jquery-plugin/
      // IE, Chrome & Safari will comply with the non-standard outerHTML, all others (FF) will have a fall-back for cloning
      return (!this.length) ? this : (this[0].outerHTML || (
        function(el){
            var div = document.createElement('div');
            div.appendChild(el.cloneNode(true));
            var contents = div.innerHTML;
            div = null;
            return contents;
      })(this[0]));
    };

    firebase.auth().onAuthStateChanged(function(user){
      if (user && user.email == 'wuct@clive.io')
          document.getElementById("not-logged-in").style.display = "none";
    });
    
    window.teamNames = {};
    window.scores = [];
    
    function addTeam(){
        var newid = parseInt(document.getElementById('newid').value);
        if(!isNaN(newid)) {
          fb.child('teams').child(newid).set({name:document.getElementById('newname').value});
          document.getElementById('newid').value = '';
          document.getElementById('newname').value = '';
        } else {
          alertFailure("Invalid team ID");
        }
        return false;
    }
    function deleteTeam(newid){
      newid = parseInt(newid);
      if(!isNaN(newid)){
        if (confirm("This will remove team "+newid+" and all of its scores. Are you sure?")){
          fb.child('teams').child(newid).remove();
          fb.child('scores').child('team'+newid).remove();
          //console.log('team'+document.getElementById('newid').value);
          document.getElementById('newid').value = '';
          document.getElementById('newname').value = '';
        }
      } else {
        alertFailure("Invalid team ID");
      }
      return false;
    }
    
    fb.child('teams').on('value', function(snapshot){
      window.teamNames = {};
      teamNames = snapshot.val();
      render();
    });
    
    function render(){
      $('#teamlist').html('');
      for(var id in teamNames)
        if(teamNames.hasOwnProperty(id) && window.teamNames[id].name)
          (function(id){
            $('#teamlist').append(
              $('<div>').append(
                $('<button class="removeBtn">&#x2715;</button>')
                .click(function(e){
                  deleteTeam(id);
                })
              ).append(' ').append(
                $("<span>"+ id + ": "+ window.teamNames[id].name +"</span>")
              )
            );
          })(id);
    }
    
    
    //Don't use this during leap seconds btw.
    (function(){
      function bindinputfb(input, ref, cb){
        ref.on('value', function(snapshot){
          input.value = parseInt(snapshot.val());
          cb(parseInt(snapshot.val()));
        });
        input.onchange = function(e){
          ref.set(parseInt(e.target.value));
          cb(parseInt(e.target.value));
        };
      }
      
      var timerlength, hidetime;
      bindinputfb(document.getElementById('timerlength'), fb.child('timer').child('timerlength'), function(x){timerlength = x;});
      bindinputfb(document.getElementById('hidetime'), fb.child('timer').child('hidetime'), function(x){hidetime = x;});
      
      document.getElementById('timerset_form').onsubmit = function(){
        var mins = parseFloat(document.getElementById('timerplus').value);
        if (!isNaN(mins)){
          fb.child('timer').child('target').set(mins * 60 * 1000 + (new Date()).getTime());
          document.getElementById('timerplus').value = '';
        } else {
          alertFailure("Invalid number of minutes");
        }
        return false;
      };
      
      setTimer(document.getElementById('timer'), function(total){
        if(total <= 0)
          document.getElementById("timer").style.color = "red";
        else
          document.getElementById("timer").style.color = "black";
      });
    }());
    
    (function(){
      teamNames = {};
      scores = [];
      fb.child('teams').on('value', function(snapshot){
        teamNames = {};
        var teams = snapshot.val();
        for(var teamId in teams)
          if(teams.hasOwnProperty(teamId))
            teamNames['team'+teamId] = teams[teamId].name;
        render();
      });
      
      fb.child('scores').on('value', function(snapshot){
        scores = [];
        var teams = snapshot.val();
        for(var teamId in teams){
          if(teams.hasOwnProperty(teamId)){
            var score = window.getScore(teams[teamId]);
            var progress = window.getProgress(teams[teamId]);
            scores.push({id: teamId, score: score, progress: progress});
          }
        }
        scores.sort(function(a,b){return b.score - a.score;});
        render();
      });
      
      function render(){
        var s = "<tr><th>Rank</th><th>Team ID</th><th>Team Name</th><th>Total Score</th>"
               +"<th>Submitted "+window.dTitle[0]+" packets (of "+window.numPackets[0]+" total)</th>"
               +"<th>Submitted "+window.dTitle[1]+" packets (of "+window.numPackets[1]+" total)</th>"
               +"<th>Submitted "+window.dTitle[2]+" packets (of "+window.numPackets[2]+" total)</th>"
               +"</tr>";
        var prevRank = 0;
        for(let i = 0; i < scores.length; i++){
          if(teamNames[scores[i].id] === undefined)
            continue;
          if(i > 0 && scores[i].score != scores[i-1].score)
            prevRank = i;
          
          s += "<tr><td>" + (prevRank + 1) + "</td><td>"+scores[i].id.slice(4)+"</td><td>" + teamNames[scores[i].id] + "</td><td>" + scores[i].score + "</td>";
          s += "<td>"+(scores[i].progress[0]*window.numPackets[0])+"</td>";
          s += "<td>"+(scores[i].progress[1]*window.numPackets[1])+"</td>";
          s += "<td>"+(scores[i].progress[2]*window.numPackets[2])+"</td>";
          s += "</tr>";
        }
        document.getElementById('scoreboard').innerHTML = "<table id='clickselectall' readonly='readonly' contenteditable>" + s + "</table>";

        document.querySelector('#clickselectall').onfocus = function(e) {
            var el = this;
            requestAnimationFrame(function() {
                selectElementContents(el);
            });
        };

        document.getElementById("scoreboard").onkeydown = function (event) {
            if (event.ctrlKey) {
                // allow Ctrl-A, Ctrl-(any arrow key) combinations
                return true;
            }
            // keycode: http://www.programming-magic.com/file/20080205232140/keycode_table.html
            if (33 <= event.keyCode && event.keyCode <= 40) {
                return true;
            }
            return false;
        };
      }
    })();

    function selectElementContents(el) {
        var range = document.createRange();
        range.selectNodeContents(el);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }
    
    fb.child("users").on('value', function(snapshot){
      $("#stations").text('');
      var allTracked = new Set();
      if(snapshot.val()){
        for(var u in snapshot.val())
          if(snapshot.val().hasOwnProperty(u) && snapshot.val()[u])
            (function(u){
              var userState = snapshot.val()[u];
              try{
                var tracking = JSON.parse(userState.tracking);
              }catch(e){
                return;
              }
              $("#stations").append(
                $('<div>').append(
                  $('<button class="removeBtn">&#x2715;</button>')
                  .click(function(e){
                    if(confirm('Are you sure you want to remove scoring station "' + (userState.identifier || 'Unidentified Station') + '"? This will log them out.'))
                    fb.child("users").child(u).set(null);
                  })
                ).append(' ').append(
                  $('<span>')
                  .append($('<i>').text(userState.identifier || 'Unidentified Station'))
                  .append(' is tracking: ')
                  .append(
                    $('<span>').append(
                      tracking ? tracking.map(t=>
                        $('<span class="teamid">').text(t)
                        .append($("<span>").text(window.teamNames['team'+t]))
                        .outerHTML()
                      ).join(', ') : 'no one'
                    )
                  )
                )
              )
              tracking.forEach(x => allTracked.add(parseInt(x)));
            })(u);
      }
      $('#stations').append($("<div>").append("<b>Untracked teams:</b> ")
      .append(Object.keys(window.teamNames).map(x=>parseInt(x.slice(4))).filter(x => !allTracked.has(x)).map(t=>
                        $('<span class="teamid">').text(t)
                        .append($("<span>").text(window.teamNames['team'+t]))
                        .outerHTML()
                      ).join(', ') || 'no one'));
    });

  </script>
  <style>
    td{
      padding: 0.3em;
    }
  </style>
</body>
</html>
