<html>
<head>
  <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase-messaging.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.3/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="main.css" />
</head>
<body>
  <style>input[type=text]{border: solid 1px #ccc;}</style>
  <header>
    <h1><img src="wuct.jpg" alt="WUCT" />Breaking Bonds Round: Control Panel</h1>
  </header>
  <h2>Timer</h2>
  <p>Timer is <input type="text" id="timerlength" /> minutes long and hides scores at <input type="text" id="hidetime" /> minutes.</p>
  <p>Set timer to <input type="text" id="timerplus" /> minutes: <input type="submit" id="timerset" /></p>
  <p>CURRENT TIMER DISPLAY: <span id="timer">not loaded yet</span></p>
  <p><i>Recommended way of using the timer is to set it to 999999999999 until you're ready to start (the timer will only display up to the limit, so it'll just sit there), then setting it to 60 (or whatever the limit may be) once the round starts.</i></p>
  
  <h2>Teams</h2>
  <input type="text" placeholder="id" id="newid" />
  <input type="text" placeholder="new name" id="newname" />
  <input type="submit" value="Set team name" onclick="addTeam();" />
  <input type="submit" value="Remove team with this ID" onclick="deleteTeam();" />
  
  <div id="app"></div>
  
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyC4siYV0A1Nq4POMUfvdRKyP0-xzUUvMVo",
      authDomain: "wuct-1f4ca.firebaseapp.com",
      databaseURL: "https://wuct-1f4ca.firebaseio.com",
      storageBucket: "wuct-1f4ca.appspot.com",
      messagingSenderId: "833633709327"
    };
    firebase.initializeApp(config);
    var fb = firebase.database().ref('wuct2018');
    
    window.teamNames = {};
    window.scores = [];
    
    function addTeam(){
        fb.child('teams').child(document.getElementById('newid').value).set({name:document.getElementById('newname').value});
        document.getElementById('newid').value = '';
        document.getElementById('newname').value = '';
        return false;
    }
    function deleteTeam(){
      fb.child('teams').child(document.getElementById('newid').value).remove();
      fb.child('scores').child('team'+document.getElementById('newid').value).remove();
      //console.log('team'+document.getElementById('newid').value);
      document.getElementById('newid').value = '';
        document.getElementById('newname').value = '';
        return false;
    }
    
    fb.child('teams').on('value', function(snapshot){
      window.teamNames = {};
      teamNames = snapshot.val();
      render();
    });
    
    function render(){
      var s = "";
      for(var id in teamNames)
        if(teamNames.hasOwnProperty(id) && window.teamNames[id].name)
          s +="<div>"+ id + ": "+ window.teamNames[id].name +"</div>";
      document.getElementById('app').innerHTML = s;
    }
    
    
    //Don't use this during leap seconds btw.
    (function(){
      function bindinputfb(input, ref, cb){
        ref.on('value', function(snapshot){
          input.value = parseInt(snapshot.val());
          cb(parseInt(snapshot.val()));
        });
        input.onchange = function(e){
          ref.set(parseInt(e.target.value));
          cb(parseInt(e.target.value));
        };
      }
      
      var timerlength, hidetime;
      bindinputfb(document.getElementById('timerlength'), fb.child('timer').child('timerlength'), function(x){timerlength = x;});
      bindinputfb(document.getElementById('hidetime'), fb.child('timer').child('hidetime'), function(x){hidetime = x;});
      
      document.getElementById('timerset').onclick = function(){
        fb.child('timer').child('target').set(parseFloat(document.getElementById('timerplus').value) * 60 * 1000 + (new Date()).getTime());
      };
      
      var currentTarget = 0;
      fb.child('timer').on('value', function(snapshot){
        if(snapshot.val()){
          currentTarget = snapshot.val().target;
        }
      });
      setInterval(function(){
        var total = Math.floor((currentTarget - (new Date()).getTime())/1000);
        if(total < 0){
          total = 0;
          document.getElementById('timer').style.color = "red";
        }else{
          document.getElementById('timer').style.color = "black";
        }
        if(total > timerlength * 60)
          total = timerlength * 60;
        var hours = "" + Math.floor(total/3600);
        var minutes = "" + Math.floor(total/60) % 60;
        var seconds = "" + total % 60;
        document.getElementById('timer').innerHTML = ((hours<10)?"0":"") + hours + ":" + ((minutes<10)?"0":"") + minutes + ":" + ((seconds<10)?"0":"") + seconds + ((total < hidetime * 60)?" [scores hidden]":" [scores not hidden]");
      }, 100);
    }());
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-62605323-4', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>
