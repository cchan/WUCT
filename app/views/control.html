<html>
<head>
  <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase-messaging.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
  <script src="common.js?<%= timestamp %>"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.3/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="main.css?<%= timestamp %>" />
</head>
<body>
  <style>input[type=text]{border: solid 1px #ccc;}</style>
  <div id="not-logged-in" style="color: red">You are not logged in. You can see these settings but cannot change them. Go to the <a href="scoring.html">scoring page</a> to log in.</div>
  <header>
    <h1><img src="wuct.jpg" alt="WUCT" />Breaking Bonds Round: Control Panel</h1>
  </header>
  <h2>Tips</h2>
  <p>The recommended way of using the timer is to set it to 999999999999 until you're ready to start (the timer will only display up to the limit, so it'll just sit there), then setting it to 60 (or whatever the limit may be) once the round starts.</p>
  <p>To disable scoreboard-hiding, set the hidden score time to a large negative value.</p>
  <p>As with the rest of this webapp, everything updates instantly as long as you're connected!</p>
  
  <h2>Timer</h2>
  <p>Timer is <input type="text" id="timerlength" /> minutes long and hides scores at <input type="text" id="hidetime" /> minutes.</p>
  <p>Set timer to <input type="text" id="timerplus" /> minutes: <input type="submit" id="timerset" /></p>
  <p>CURRENT TIMER DISPLAY: <span id="timer">not loaded yet</span></p>
  
  <h2>Teams</h2>
  <input type="text" placeholder="id" id="newid" />
  <input type="text" placeholder="new name" id="newname" />
  <input type="submit" value="Set team name" onclick="addTeam();" />
  <input type="submit" value="Remove team with this ID" onclick="deleteTeam();" />
  
  <div id="teamlist"></div>
  
  <script>
    firebase.auth().onAuthStateChanged(function(user){
      if (user && user.email == 'wuct@clive.io')
          document.getElementById("not-logged-in").style.display = "none";
    });
    
    window.teamNames = {};
    window.scores = [];
    
    function addTeam(){
        fb.child('teams').child(document.getElementById('newid').value).set({name:document.getElementById('newname').value});
        document.getElementById('newid').value = '';
        document.getElementById('newname').value = '';
        return false;
    }
    function deleteTeam(){
      fb.child('teams').child(document.getElementById('newid').value).remove();
      fb.child('scores').child('team'+document.getElementById('newid').value).remove();
      //console.log('team'+document.getElementById('newid').value);
      document.getElementById('newid').value = '';
        document.getElementById('newname').value = '';
        return false;
    }
    
    fb.child('teams').on('value', function(snapshot){
      window.teamNames = {};
      teamNames = snapshot.val();
      render();
    });
    
    function render(){
      var s = "";
      for(var id in teamNames)
        if(teamNames.hasOwnProperty(id) && window.teamNames[id].name)
          s +="<div>"+ id + ": "+ window.teamNames[id].name +"</div>";
      document.getElementById('teamlist').innerHTML = s;
    }
    
    
    //Don't use this during leap seconds btw.
    (function(){
      function bindinputfb(input, ref, cb){
        ref.on('value', function(snapshot){
          input.value = parseInt(snapshot.val());
          cb(parseInt(snapshot.val()));
        });
        input.onchange = function(e){
          ref.set(parseInt(e.target.value));
          cb(parseInt(e.target.value));
        };
      }
      
      var timerlength, hidetime;
      bindinputfb(document.getElementById('timerlength'), fb.child('timer').child('timerlength'), function(x){timerlength = x;});
      bindinputfb(document.getElementById('hidetime'), fb.child('timer').child('hidetime'), function(x){hidetime = x;});
      
      document.getElementById('timerset').onclick = function(){
        fb.child('timer').child('target').set(parseFloat(document.getElementById('timerplus').value) * 60 * 1000 + (new Date()).getTime());
      };
      
      setTimer(document.getElementById('timer'), function(total){
        if(total <= 0)
          document.getElementById("timer").style.color = "red";
        else
          document.getElementById("timer").style.color = "black";
      });
    }());
  </script>
</body>
</html>
